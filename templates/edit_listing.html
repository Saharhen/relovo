{% extends "base.html" %}
{% block content %}

<section class="page-section">
  <div class="page-card page-card-narrow">
    <h2 class="page-title">{{ _("–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ") }}</h2>

    <form method="POST"
      enctype="multipart/form-data"
      class="listing-form"
      id="edit-listing-form">

      <div class="input-group">
        <label>{{ _("–ù–∞–∑–≤–∞–Ω–∏–µ") }}</label>
        <input type="text" name="title" value="{{ listing.title }}" required>
      </div>

      <div class="input-row">
        <div class="input-group">
          <label>{{ _("–ì–æ—Ä–æ–¥") }}</label>
          <input type="text" name="city" value="{{ listing.city }}" required>
        </div>
        <div class="input-group">
          <label>{{ _("–¶–µ–Ω–∞ (‚Ç¨ / –º–µ—Å)") }}</label>
          <input type="number" name="price" value="{{ listing.price }}" required>
        </div>
      </div>

      <div class="input-group">
        <label>{{ _("–¢–∏–ø –∂–∏–ª—å—è") }}</label>
        <select name="type" required>
          <option value="apartment" {% if listing.type == "apartment" %}selected{% endif %}>{{ _("–ö–≤–∞—Ä—Ç–∏—Ä–∞") }}</option>
          <option value="room" {% if listing.type == "room" %}selected{% endif %}>{{ _("–ö–æ–º–Ω–∞—Ç–∞") }}</option>
          <option value="house" {% if listing.type == "house" %}selected{% endif %}>{{ _("–î–æ–º") }}</option>
        </select>
      </div>

      <div class="input-group">
        <label>{{ _("–û–ø–∏—Å–∞–Ω–∏–µ") }}</label>
        <textarea name="description" rows="4">{{ listing.description }}</textarea>
      </div>

      <div class="input-group">
        <label>{{ _("–î–æ–±–∞–≤–∏—Ç—å –µ—â—ë —Ñ–æ—Ç–æ") }}</label>

        <div class="photo-upload" id="photo-upload">
          <div class="drop-zone" id="drop-zone">
            <div class="drop-icon">üì∑</div>
            <div class="drop-text">
              <strong>{{ _("–ü–µ—Ä–µ—Ç–∞—â–∏ —Å—é–¥–∞ —Ñ–æ—Ç–æ") }}</strong><br>
              {{ _("–∏–ª–∏ –Ω–∞–∂–º–∏, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å") }}
            </div>

            <!-- –í–ê–ñ–ù–û: –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∏–º—è –ø–æ–ª—è -->
            <input type="file" id="file-input" name="images[]" accept="image/*" multiple>
          </div>

          <div class="preview-grid" id="preview-grid"></div>
        </div>
      </div>
      
      {% if listing.images %}
      <div class="input-group">
        <label>{{ _("–¢–µ–∫—É—â–∏–µ —Ñ–æ—Ç–æ (–ø–µ—Ä–µ—Ç–∞—â–∏, —á—Ç–æ–±—ã –ø–æ–º–µ–Ω—è—Ç—å –ø–æ—Ä—è–¥–æ–∫)") }}</label>

        <div class="preview-grid" id="existing-grid">
          {% for img in listing.images %}
          <div class="preview-item existing {% if loop.first %}main-photo{% endif %}"
              data-img-id="{{ img.id }}"
              style="cursor: grab;">

            {% if loop.first %}
              <div class="main-photo-star" title="{{ _('–ì–ª–∞–≤–Ω–æ–µ —Ñ–æ—Ç–æ') }}">‚òÖ</div>
            {% endif %}

            <img src="/static/uploads/{{ img.filename }}" alt="">

            <button type="button"
                    class="delete-img-btn"
                    onclick="location.href='/delete-image/{{ img.id }}'">
              {{ _('–£–¥–∞–ª–∏—Ç—å') }}
            </button>
          </div>
          {% endfor %}
        </div>


      </div>
      {% endif %}


      <button type="submit" class="primary-btn full-btn">{{ _("–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è") }}</button>
    </form>
  </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

<script>
  const grid = document.getElementById("existing-grid");
  if (grid) {
    new Sortable(grid, {
      animation: 150,
      onEnd: updateMainPhotoStar
    });
  }

  function updateMainPhotoStar() {
    const items = document.querySelectorAll("#existing-grid .preview-item");

    items.forEach((item, index) => {
      item.classList.remove("main-photo");
      const star = item.querySelector(".main-photo-star");
      if (star) star.remove();

      if (index === 0) {
        item.classList.add("main-photo");

        const starDiv = document.createElement("div");
        starDiv.className = "main-photo-star";
        starDiv.innerText = "‚òÖ";
        starDiv.title = "–ì–ª–∞–≤–Ω–æ–µ —Ñ–æ—Ç–æ";

        item.appendChild(starDiv);
      }
    });
  }


  const form = document.getElementById("edit-listing-form");

  if (form && grid) {
    form.addEventListener("submit", async function (e) {
      // –µ—Å–ª–∏ —Ñ–æ—Ç–æ –µ—Å—Ç—å ‚Äî —Å–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Ä—è–¥–æ–∫
      const items = Array.from(
        document.querySelectorAll("#existing-grid .existing")
      );

      if (items.length > 0) {
        e.preventDefault(); // —Å—Ç–æ–ø–∞–µ–º –æ–±—ã—á–Ω—ã–π submit

        const orderedIds = items.map(el => Number(el.dataset.imgId));

        try {
          const res = await fetch(
            "/listing/{{ listing.id }}/images/reorder",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ ordered_ids: orderedIds })
            }
          );

          if (!res.ok) {
            alert("‚ùå Fehler beim Speichern der Bildreihenfolge");
            return;
          }

          // –ø–æ—Ä—è–¥–æ–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω ‚Üí —Ç–µ–ø–µ—Ä—å —Ä–µ–∞–ª—å–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É
          form.submit();

        } catch (err) {
          alert("‚ùå Netzwerkfehler");
        }
      }
    });
  }
</script>



{% endblock %}
