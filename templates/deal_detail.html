<!DOCTYPE html>
<html lang="{{ get_locale() }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ _("–°–¥–µ–ª–∫–∞") }} #{{ deal.id }} ‚Äî Relovo</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="icon" type="image/png" href="/static/favicon.png" sizes="512x512">
</head>

<body>
<header class="navbar">
    <a href="/"
       class="logo-link"
       style="font-size:22px; color:#6A39FF; font-weight:700; text-decoration:none;">
        Relovo
    </a>
    <nav>
        <a href="/deals">{{ _("–°–¥–µ–ª–∫–∏") }}</a>
        <a href="/dashboard">{{ _("–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç") }}</a>
        <a href="/logout" class="nav-login-btn">{{ _("–í—ã–π—Ç–∏") }}</a>
    </nav>
</header>

<div class="container deal-page">

    <h1>{{ _("–°–¥–µ–ª–∫–∞") }} #{{ deal.id }}</h1>

    <!-- PARTICIPANTS -->
    <section class="card">
        <h3>{{ _("–£—á–∞—Å—Ç–Ω–∏–∫–∏") }}</h3>

        <p><strong>{{ _("–ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä") }}:</strong>
            {{ deal.tenant.name or _("–ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä") }}
        </p>

        <p><strong>{{ _("–í–ª–∞–¥–µ–ª–µ—Ü") }}:</strong>
            {% if role == "admin" %}
                {{ deal.landlord.email }}
            {% else %}
                {{ deal.landlord.name or _("–í–ª–∞–¥–µ–ª–µ—Ü") }}
            {% endif %}
        </p>
    </section>

    <!-- STATUS -->
    <section class="card">
        <h3>{{ _("–°—Ç–∞—Ç—É—Å —Å–¥–µ–ª–∫–∏") }}</h3>
        <span class="status-badge status-{{ deal.status }}">
            <span class="status-text">{{ _(deal.status) }}</span>
        </span>
    </section>

    <!-- RENTAL DATES -->
    <div class="info-block">
        <h3>{{ _("–ü–µ—Ä–∏–æ–¥ –∞—Ä–µ–Ω–¥—ã") }}</h3>

        {% if deal.start_date and deal.end_date %}
            <p>
                {{ deal.start_date.strftime("%d.%m.%Y") }}
                ‚Üí
                {{ deal.end_date.strftime("%d.%m.%Y") }}
            </p>

            {% if deal.dates_confirmed %}
                <div class="dates-approved-box">
                    <span class="dates-approved-icon">‚úì</span>
                    <span class="dates-approved-text">
                        {{ _("–î–∞—Ç—ã –∞—Ä–µ–Ω–¥—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω—ã") }}
                    </span>
                </div>
            {% else %}
                <span class="badge pending">
                    {{ _("–û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º") }}
                </span>
            {% endif %}
        {% endif %}

        {% if role == "tenant" and not deal.dates_confirmed %}
        <form method="POST"
              action="/deal/{{ deal.id }}/dates"
              class="date-form">

            <label>{{ _("–î–∞—Ç–∞ –∑–∞–µ–∑–¥–∞") }}</label>
            <input type="date"
                   name="start_date"
                   required
                   value="{{ deal.start_date or '' }}">

            <label>{{ _("–î–∞—Ç–∞ –≤—ã–µ–∑–¥–∞") }}</label>
            <input type="date"
                   name="end_date"
                   required
                   value="{{ deal.end_date or '' }}">

            <button class="primary-btn">
                {{ _("–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞—Ç—ã") }}
            </button>
        </form>
        {% endif %}
    </div>

    <!-- CONTRACT (Admin uploads unsigned PDF; parties upload signed PDFs) -->
    <section class="card">
        <h3>{{ _("–î–æ–≥–æ–≤–æ—Ä") }}</h3>

        {% if contract %}
            <p>
                üìÑ <strong>{{ _("–î–æ–≥–æ–≤–æ—Ä (PDF, –±–µ–∑ –ø–æ–¥–ø–∏—Å–∏)") }}</strong>
                ‚Äî <a href="/static/{{ contract.unsigned_filename }}" target="_blank">{{ _("–û—Ç–∫—Ä—ã—Ç—å") }}</a>
            </p>

            {# SHA –ª—É—á—à–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—É (–æ–±—ã—á–Ω—ã–º —é–∑–µ—Ä–∞–º —ç—Ç–æ –Ω–µ –Ω—É–∂–Ω–æ) #}
            {% if contract.unsigned_sha256 and role == "admin" %}
            <p class="small-muted">
                {{ _("–û—Ç–ø–µ—á–∞—Ç–æ–∫ SHA-256") }}:
                <code>{{ contract.unsigned_sha256 }}</code>
            </p>
            {% endif %}

            {% if role == "admin" %}
            <hr>
            <form method="POST"
                  action="/deal/{{ deal.id }}/contract/upload_unsigned"
                  enctype="multipart/form-data"
                  class="upload-form">

                <label>{{ _("–ó–∞–º–µ–Ω–∏—Ç—å –¥–æ–≥–æ–≤–æ—Ä (PDF, –±–µ–∑ –ø–æ–¥–ø–∏—Å–∏)") }}</label>
                <input type="file" name="file" accept="application/pdf" required>

                <button class="primary-btn">
                    {{ _("–ó–∞–≥—Ä—É–∑–∏—Ç—å") }}
                </button>

                <p class="small-muted">
                    {{ _("–ü–æ—Å–ª–µ –∑–∞–º–µ–Ω—ã –¥–æ–≥–æ–≤–æ—Ä–∞ –ø–æ–¥–ø–∏—Å–∏ —Å—Ç–æ—Ä–æ–Ω –Ω—É–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–Ω–æ–≤–æ (–µ—Å–ª–∏ —Ç—ã —Ç–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏–ª –≤ –±—ç–∫–µ–Ω–¥–µ).") }}
                </p>
            </form>
            {% endif %}

            <hr>

            <h4>{{ _("–ü–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–µ –≤–µ—Ä—Å–∏–∏") }}</h4>

            {# --------- FIX: signed_contracts –º–æ–∂–µ—Ç –±—ã—Ç—å dict –ò–õ–ò list --------- #}
            {% set tenant_signed = None %}
            {% set landlord_signed = None %}

            {% if signed_contracts is mapping %}
                {% set tenant_signed = signed_contracts.get("tenant") %}
                {% set landlord_signed = signed_contracts.get("landlord") %}
            {% else %}
                {% for s in signed_contracts %}
                    {% if s.party == "tenant" %}{% set tenant_signed = s %}{% endif %}
                    {% if s.party == "landlord" %}{% set landlord_signed = s %}{% endif %}
                {% endfor %}
            {% endif %}
            {# --------------------------------------------------------------- #}

            <ul class="doc-list">
                <li class="doc-item">
                    <div class="doc-left">
                        ‚úçÔ∏è <strong>{{ _("–ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä") }}</strong>
                        {% if tenant_signed %}
                            <span class="badge approved">{{ _("–ó–∞–≥—Ä—É–∂–µ–Ω–æ") }}</span>
                            {% if tenant_signed.sha256 and role == "admin" %}
                            <div class="small-muted">
                                SHA-256: <code>{{ tenant_signed.sha256 }}</code>
                            </div>
                            {% endif %}
                        {% else %}
                            <span class="badge pending">{{ _("–ï—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ") }}</span>
                        {% endif %}
                    </div>
                    <div class="doc-right">
                        {% if tenant_signed %}
                            <a href="/static/{{ tenant_signed.filename }}" target="_blank">{{ _("–û—Ç–∫—Ä—ã—Ç—å") }}</a>
                        {% endif %}
                    </div>
                </li>

                <li class="doc-item">
                    <div class="doc-left">
                        ‚úçÔ∏è <strong>{{ _("–í–ª–∞–¥–µ–ª–µ—Ü") }}</strong>
                        {% if landlord_signed %}
                            <span class="badge approved">{{ _("–ó–∞–≥—Ä—É–∂–µ–Ω–æ") }}</span>
                            {% if landlord_signed.sha256 and role == "admin" %}
                            <div class="small-muted">
                                SHA-256: <code>{{ landlord_signed.sha256 }}</code>
                            </div>
                            {% endif %}
                        {% else %}
                            <span class="badge pending">{{ _("–ï—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ") }}</span>
                        {% endif %}
                    </div>
                    <div class="doc-right">
                        {% if landlord_signed %}
                            <a href="/static/{{ landlord_signed.filename }}" target="_blank">{{ _("–û—Ç–∫—Ä—ã—Ç—å") }}</a>
                        {% endif %}
                    </div>
                </li>
            </ul>

            {% if role in ["tenant", "landlord"] %}
            <hr>
            <form method="POST"
                  action="/deal/{{ deal.id }}/contract/upload"
                  enctype="multipart/form-data"
                  class="upload-form">

                <label>{{ _("–ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π –¥–æ–≥–æ–≤–æ—Ä (PDF)") }}</label>
                <input type="file" name="file" accept="application/pdf" required>

                <button class="primary-btn">
                    {{ _("–ó–∞–≥—Ä—É–∑–∏—Ç—å") }}
                </button>

                <p class="small-muted">
                    {{ _("–ó–∞–≥—Ä—É–∂–∞–π PDF —Å –ø–æ–¥–ø–∏—Å—å—é. –§–∞–π–ª –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.") }}
                </p>
            </form>
            {% endif %}

        {% else %}
            <p>{{ _("–î–æ–≥–æ–≤–æ—Ä –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º") }}</p>

            {% if role == "admin" %}
            <form method="POST"
                  action="/deal/{{ deal.id }}/contract/upload_unsigned"
                  enctype="multipart/form-data"
                  class="upload-form">

                <label>{{ _("–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–≥–æ–≤–æ—Ä (PDF, –±–µ–∑ –ø–æ–¥–ø–∏—Å–∏)") }}</label>
                <input type="file" name="file" accept="application/pdf" required>

                <button class="primary-btn">
                    {{ _("–ó–∞–≥—Ä—É–∑–∏—Ç—å") }}
                </button>

                <p class="small-muted">
                    {{ _("–≠—Ç–æ –±—É–¥–µ—Ç –±–∞–∑–æ–≤—ã–π –¥–æ–≥–æ–≤–æ—Ä, –∫–æ—Ç–æ—Ä—ã–π —Å—Ç–æ—Ä–æ–Ω—ã –ø–æ–¥–ø–∏—à—É—Ç –∏ –∑–∞–≥—Ä—É–∑—è—Ç –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–µ –≤–µ—Ä—Å–∏–∏.") }}
                </p>
            </form>
            {% else %}
                <span class="badge pending">
                    {{ _("–û–∂–∏–¥–∞–π—Ç–µ: –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∏—Ç –¥–æ–≥–æ–≤–æ—Ä") }}
                </span>
            {% endif %}
        {% endif %}
    </section>

    <!-- DOCUMENTS -->
    <section class="card">
        <h3>{{ _("–î–æ–∫—É–º–µ–Ω—Ç—ã") }}</h3>

        {% if docs %}
        <ul class="doc-list">
            {% for d in docs %}
            <li class="doc-item">
                <div class="doc-left">
                    üìÑ <strong>{{ _(d.doc_type) }}</strong>

                    {% if d.status == "pending" %}
                        <span class="badge pending">{{ _("–û–∂–∏–¥–∞–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏") }}</span>
                    {% elif d.status == "approved" %}
                        <span class="badge approved">{{ _("–ü–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω") }}</span>
                    {% elif d.status == "rejected" %}
                        <span class="badge rejected">{{ _("–û—Ç–∫–ª–æ–Ω—ë–Ω") }}</span>
                    {% endif %}

                    {% if d.status == "rejected" and d.note %}
                        <div class="doc-reject-note">
                            {{ _("–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è") }}:
                            <em>{{ d.note }}</em>
                        </div>
                    {% endif %}
                </div>

                <div class="doc-right">
                    <a href="/static/{{ d.filename }}" target="_blank">
                        {{ _("–û—Ç–∫—Ä—ã—Ç—å") }}
                    </a>
                </div>
            </li>
            {% endfor %}
        </ul>
        {% else %}
            <p>{{ _("–î–æ–∫—É–º–µ–Ω—Ç—ã –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã") }}</p>
        {% endif %}

        {% if role in ["tenant", "landlord"] %}
        <hr>

        <form method="POST"
              action="/deal/{{ deal.id }}/upload"
              enctype="multipart/form-data"
              class="upload-form">

            <label>{{ _("–¢–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞") }}</label>
            <select name="doc_type" required>
                {% for key, label in doc_types %}
                    <option value="{{ key }}">{{ _(label) }}</option>
                {% endfor %}
            </select>

            <input type="file" name="file" required>

            <button class="primary-btn">
                {{ _("–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç") }}
            </button>
        </form>
        {% endif %}
    </section>

    <!-- HISTORY -->
    <section class="card">
        <h3>{{ _("–ò—Å—Ç–æ—Ä–∏—è") }}</h3>

        {% if audit_log %}
        <ul class="audit-list">
            {% for a in audit_log %}
            <li class="audit-item">
                {% if a.action == "deal_created" %}
                    üü¢ {{ _("–°–¥–µ–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–∞") }}
                {% elif a.action == "doc_upload" %}
                    üìÑ {{ _("–ó–∞–≥—Ä—É–∂–µ–Ω –¥–æ–∫—É–º–µ–Ω—Ç") }}
                {% elif a.action == "doc_review" %}
                    üßê {{ _("–î–æ–∫—É–º–µ–Ω—Ç –ø—Ä–æ–≤–µ—Ä–µ–Ω") }}
                {% elif a.action == "status_change" %}
                    üîÑ {{ _("–°—Ç–∞—Ç—É—Å —Å–¥–µ–ª–∫–∏ –∏–∑–º–µ–Ω—ë–Ω") }}
                {% elif a.action == "deal_canceled" %}
                    ‚ùå {{ _("–°–¥–µ–ª–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞") }}
                {% else %}
                    ‚Ñπ {{ _("–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–¥–µ–ª–∫–∏") }}
                {% endif %}

                <div class="audit-time">
                    {{ a.created_at.strftime("%d.%m.%Y %H:%M") }}
                </div>

                {% if role == "admin" and a.meta %}
                <div class="audit-meta">
                    <small>{{ a.meta }}</small>
                </div>
                {% endif %}
            </li>
            {% endfor %}
        </ul>
        {% else %}
            <p>{{ _("–ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫–∞ –ø—É—Å—Ç–∞") }}</p>
        {% endif %}
    </section>

</div>

</body>
</html>
