<!DOCTYPE html>
<html lang="{{ get_locale() }}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ listing.title }} ‚Äî Relovo</title>
  <link rel="stylesheet" href="/static/style.css">
  <link rel="icon" type="image/png" href="/static/favicon.png" sizes="512x512">
</head>

<body>

<header class="navbar">
  <span style="font-size:22px; color:#6A39FF; font-weight:700;">Relovo</span>
  <nav>
    <a href="/listings">{{ _("–û–±—ä—è–≤–ª–µ–Ω–∏—è") }}</a>
    {% if session.get("user_id") %}
      <a href="/dashboard">{{ _("–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç") }}</a>
      <a href="/logout" class="nav-login-btn">{{ _("–í—ã–π—Ç–∏") }}</a>
    {% else %}
      <a href="/login" class="nav-login-btn">{{ _("–í–æ–π—Ç–∏") }}</a>
    {% endif %}
  </nav>
</header>

<div class="container">

  <h1>{{ listing.title }}</h1>

  <p class="city">
    {{ listing.city }} ‚Ä¢ ‚Ç¨{{ listing.price }}/{{ _("–º–µ—Å") }}
  </p>

  <!-- RESERVE BLOCK (FIX: check if existing_deal is defined) -->
  {% if session.get("user_id") and user and user.id != listing.user_id %}
    <div class="reserve-box">
      {% if existing_deal is defined and existing_deal %}
        <a href="/deal/{{ existing_deal.id }}" class="primary-btn">
          {{ _("–û—Ç–∫—Ä—ã—Ç—å —Å–¥–µ–ª–∫—É") }}
        </a>
        <p class="deal-status">
          {{ _("–°—Ç–∞—Ç—É—Å") }}: <strong>{{ existing_deal.status }}</strong>
        </p>
      {% else %}
        <form method="POST" action="/reserve/{{ listing.id }}">
          <button class="primary-btn">
            üõ° {{ _("–ó–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ Relovo") }}
          </button>
        </form>
        <p class="reserve-hint">
          {{ _("–†–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞—ë—Ç —Å–¥–µ–ª–∫—É. –î–æ–∫—É–º–µ–Ω—Ç—ã –∏ –æ–ø–ª–∞—Ç–∞ –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ Relok.") }}
        </p>
      {% endif %}
    </div>
  {% elif not session.get("user_id") %}
    <div class="reserve-box">
      <a href="/login" class="primary-btn">
        {{ _("–í–æ–π—Ç–∏, —á—Ç–æ–±—ã –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞—Ç—å") }}
      </a>
    </div>
  {% endif %}

  <!-- GALLERY -->
  <div class="listing-gallery">
    {% for img in listing.images[:5] %}
      <img src="/static/uploads/{{ img.filename }}"
           class="gallery-img"onclick='openSlider({{ loop.index0 }})'>
    {% endfor %}
  </div>

  {% if listing.images|length > 5 %}
    <button class="show-all-btn"
            onclick="window.location.href='/listing/{{ listing.id }}/photos'">
      {{ _("–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏") }} ({{ listing.images|length }})
    </button>
  {% endif %}

  <!-- DESCRIPTION -->
  {% if listing.description %}
    <p class="description">{{ listing.description }}</p>
  {% else %}
    <p class="description" style="opacity:.7;">{{ _("–û–ø–∏—Å–∞–Ω–∏–µ –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ") }}</p>
  {% endif %}

  <hr>

  <!-- REVIEWS -->
  <h2 class="section-title">{{ _("–û—Ç–∑—ã–≤—ã") }}</h2>

  <div class="reviews-container">
    {% if reviews %}
      {% for r in reviews %}
        <div class="review-card">
          <div class="review-header">
            <div class="review-stars">
              {% for i in range(r.rating) %}‚òÖ{% endfor %}
              {% for i in range(5 - r.rating) %}‚òÜ{% endfor %}
            </div>

            <span class="review-author">{{ r.user.email }}</span>
            <span class="review-date">{{ r.created_at.strftime('%d.%m.%Y') }}</span>
          </div>

          {% if r.text %}
            <p class="review-text">{{ r.text }}</p>
          {% endif %}
        </div>
      {% endfor %}
    {% else %}
      <p>{{ _("–û—Ç–∑—ã–≤–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç") }}</p>
    {% endif %}
  </div>

  <!-- ADD REVIEW FORM -->
  <div class="review-form">

    {% if not session.get("user_id") %}
      <p style="margin:0;">
        <a href="/login" class="nav-login-btn">{{ _("–í–æ–π—Ç–∏") }}</a>
        {{ _("—á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤") }}
      </p>
    {% else %}

      {# hide form if user already left a review #}
      {% set ns = namespace(my_review=false) %}
      {% for r in reviews %}
        {% if user and r.user_id == user.id %}
          {% set ns.my_review = true %}
        {% endif %}
      {% endfor %}

      {% if ns.my_review %}
        <p style="margin:0; opacity:.75;">{{ _("–í—ã —É–∂–µ –æ—Å—Ç–∞–≤–∏–ª–∏ –æ—Ç–∑—ã–≤ –¥–ª—è —ç—Ç–æ–≥–æ –æ–±—ä—è–≤–ª–µ–Ω–∏—è.") }}</p>
      {% else %}
        <h3 style="margin-top:0;">{{ _("–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤") }}</h3>

        <form method="POST" action="/listing/{{ listing.id }}/review">
          <div class="input-group">
            <label>{{ _("–û—Ü–µ–Ω–∫–∞") }}</label>
            <select name="rating" required>
              <option value="5">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ (5)</option>
              <option value="4">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ (4)</option>
              <option value="3">‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ (3)</option>
              <option value="2">‚òÖ‚òÖ‚òÜ‚òÜ‚òÜ (2)</option>
              <option value="1">‚òÖ‚òÜ‚òÜ‚òÜ‚òÜ (1)</option>
            </select>
          </div>

          <div class="input-group">
            <label>{{ _("–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π") }}</label>
            <textarea name="text" placeholder="{{ _('–ù–∞–ø–∏—à–∏—Ç–µ –ø–∞—Ä—É —Å–ª–æ–≤...') }}"></textarea>
          </div>

          <button class="primary-btn" type="submit">
            {{ _("–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤") }}
          </button>
        </form>
      {% endif %}
    {% endif %}
  </div>

</div>

<!-- SLIDER -->
<div id="slider" class="slider-overlay">
  <span class="slider-close" onclick="closeSlider()">√ó</span>
  <button class="slider-arrow left" onclick="prevSlide()">‚Äπ</button>
  <img id="sliderImage" class="slider-image">
  <button class="slider-arrow right" onclick="nextSlide()">‚Ä∫</button>
</div>


<script>
const images = [
    {% for img in listing.images %}
        "/static/uploads/{{ img.filename }}",
    {% endfor %}
];

let currentIndex = 0;

function openSlider(index) {
    currentIndex = index;
    document.getElementById("sliderImage").src = images[currentIndex];
    document.getElementById("slider").classList.add("active");
}

function closeSlider() {
    document.getElementById("slider").classList.remove("active");
}

function nextSlide() {
    currentIndex = (currentIndex + 1) % images.length;
    document.getElementById("sliderImage").src = images[currentIndex];
}

function prevSlide() {
    currentIndex = (currentIndex - 1 + images.length) % images.length;
    document.getElementById("sliderImage").src = images[currentIndex];
}
</script>

</body>
</html>
