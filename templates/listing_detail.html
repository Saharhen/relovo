<!DOCTYPE html>
<html lang="{{ get_locale() }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ listing.title }} ‚Äî Relovo</title>
    <link rel="stylesheet" href="/static/style.css">
    <!-- favicon -->
    <link rel="icon" type="image/png" href="/static/favicon.png" sizes="512x512">
</head>

<body>

<header class="navbar">
    <span style="font-size:22px; color:#6A39FF; font-weight:700;">Relovo</span>
    <nav>
        <a href="/listings">{{ _("–û–±—ä—è–≤–ª–µ–Ω–∏—è") }}</a>
        {% if session.get("user_id") %}
            <a href="/dashboard">{{ _("–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç") }}</a>
            <a href="/logout" class="nav-login-btn">{{ _("–í—ã–π—Ç–∏") }}</a>
        {% else %}
            <a href="/login" class="nav-login-btn">{{ _("–í–æ–π—Ç–∏") }}</a>
        {% endif %}
    </nav>
</header>

<div class="container">

    <!-- TITLE -->
    <h1>{{ listing.title }}</h1>

    <!-- META -->
    <p class="city">
        {{ listing.city }} ‚Ä¢ ‚Ç¨{{ listing.price }}/{{ _("–º–µ—Å") }}
    </p>

    <!-- RESERVE BLOCK -->
    {% if session.get("user_id") and user.id != listing.user_id %}
        <div class="reserve-box">
            {% if existing_deal %}
                <a href="/deal/{{ existing_deal.id }}" class="primary-btn">
                    {{ _("–û—Ç–∫—Ä—ã—Ç—å —Å–¥–µ–ª–∫—É") }}
                </a>
                <p class="deal-status">
                    {{ _("–°—Ç–∞—Ç—É—Å") }}:
                    <strong>{{ existing_deal.status }}</strong>
                </p>
            {% else %}
                <form method="POST" action="/reserve/{{ listing.id }}">
                    <button class="primary-btn">
                        üõ° {{ _("–ó–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ Relovo") }}
                    </button>
                </form>
                <p class="reserve-hint">
                    {{ _("–†–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞—ë—Ç —Å–¥–µ–ª–∫—É. –î–æ–∫—É–º–µ–Ω—Ç—ã –∏ –æ–ø–ª–∞—Ç–∞ –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ Relok.") }}
                </p>
            {% endif %}
        </div>
    {% elif not session.get("user_id") %}
        <div class="reserve-box">
            <a href="/login" class="primary-btn">
                {{ _("–í–æ–π—Ç–∏, —á—Ç–æ–±—ã –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞—Ç—å") }}
            </a>
        </div>
    {% endif %}

    <!-- GALLERY -->
    <div class="listing-gallery">
        {% for img in listing.images[:5] %}
            <img src="/static/uploads/{{ img.filename }}"
                 class="gallery-img"onclick='openSlider({{ loop.index0 }})'>
        {% endfor %}
    </div>

    {% if listing.images|length > 5 %}
        <button class="show-all-btn"
                onclick="window.location.href='/listing/{{ listing.id }}/photos'">
            {{ _("–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏") }} ({{ listing.images|length }})
        </button>
    {% endif %}

    <!-- DESCRIPTION -->
    {% if listing.description %}
        <p class="description">{{ listing.description }}</p>
    {% else %}
        <p class="description" style="opacity:.7;">{{ _("–û–ø–∏—Å–∞–Ω–∏–µ –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ") }}</p>
    {% endif %}
<!--
    {% if session.get("user_id") and user and user.id == listing.user_id %}
        <div class="card" style="margin-top:14px;">
            <h3 style="margin-top:0;">{{ _("–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ") }}</h3>

            <form method="POST" action="/listing/{{ listing.id }}/update-description">
                <textarea name="description"
                        rows="6"
                        style="width:100%;"
                        placeholder="{{ _('–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ...') }}">{{ listing.description or "" }}</textarea>

                <button class="primary-btn" type="submit" style="margin-top:10px;">
                    {{ _("–°–æ—Ö—Ä–∞–Ω–∏—Ç—å") }}
                </button>
            </form>
        </div>
    {% endif %}
    -->
    <hr>

    <!-- REVIEWS -->
    <h2 class="section-title">{{ _("–û—Ç–∑—ã–≤—ã") }}</h2>

    <div class="reviews-container">
        {% if reviews %}
            {% for r in reviews %}
            <div class="review-card">

                <div class="review-header">
                    <div class="review-stars">
                        {% for i in range(r.rating) %}‚òÖ{% endfor %}
                        {% for i in range(5 - r.rating) %}‚òÜ{% endfor %}
                    </div>

                    <span class="review-author">{{ r.user.email }}</span>
                    <span class="review-date">
                        {{ r.created_at.strftime('%d.%m.%Y') }}
                    </span>
                </div>

                {% if r.text %}
                    <p class="review-text">{{ r.text }}</p>
                {% endif %}

            </div>
            {% endfor %}
        {% else %}
            <p>{{ _("–û—Ç–∑—ã–≤–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç") }}</p>
        {% endif %}
    </div>

</div>

<!-- SLIDER -->
<div id="slider" class="slider-overlay">
    <span class="slider-close" onclick="closeSlider()">√ó</span>
    <button class="slider-arrow left" onclick="prevSlide()">‚Äπ</button>
    <img id="sliderImage" class="slider-image">
    <button class="slider-arrow right" onclick="nextSlide()">‚Ä∫</button>
</div>

<script>
const images = [
    {% for img in listing.images %}
        "/static/uploads/{{ img.filename }}",
    {% endfor %}
];

let currentIndex = 0;

function openSlider(index) {
    currentIndex = index;
    document.getElementById("sliderImage").src = images[currentIndex];
    document.getElementById("slider").classList.add("active");
}

function closeSlider() {
    document.getElementById("slider").classList.remove("active");
}

function nextSlide() {
    currentIndex = (currentIndex + 1) % images.length;
    document.getElementById("sliderImage").src = images[currentIndex];
}

function prevSlide() {
    currentIndex = (currentIndex - 1 + images.length) % images.length;
    document.getElementById("sliderImage").src = images[currentIndex];
}
</script>

</body>
</html>
