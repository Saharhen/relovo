{% extends "base.html" %}
{% block content %}

<section class="page-section">
  <div class="page-card page-card-narrow">

    <div class="deal-header">
      <div>
        <h1 style="margin:0 0 6px;">
          Admin ‚Ä¢ {{ _("–°–¥–µ–ª–∫–∞") }} #{{ deal.id }}
        </h1>

        <div style="opacity:.75;">
          {{ deal.listing.title }} ‚Ä¢ {{ deal.listing.city }} ‚Ä¢ {{ deal.listing.price }} ‚Ç¨
        </div>

        <div style="opacity:.75; margin-top:6px;">
          Tenant: {{ deal.tenant.email }} ‚Ä¢ Landlord: {{ deal.landlord.email }}
        </div>
      </div>

      <div class="deal-status-badge status-{{ deal.status }}">
        {{ _(deal.status) }}
      </div>
    </div>

    <!-- RENTAL DATES -->
    <div class="deal-block">
      <h3 style="margin:0 0 12px;">{{ _("–ü–µ—Ä–∏–æ–¥ –∞—Ä–µ–Ω–¥—ã") }}</h3>

      {% if deal.start_date and deal.end_date %}
        <div style="margin-bottom:10px;">
          {{ deal.start_date.strftime("%d.%m.%Y") }}
          ‚Üí
          {{ deal.end_date.strftime("%d.%m.%Y") }}
        </div>

        {% if not deal.dates_confirmed %}
          <form method="POST"
                action="/admin/deal/{{ deal.id }}/confirm-dates">
            <button class="primary-btn" type="submit">
              {{ _("–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –¥–∞—Ç—ã") }}
            </button>
          </form>
        {% else %}
          <span class="doc-status status-approved">
            {{ _("–î–∞—Ç—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω—ã") }}
          </span>
        {% endif %}
      {% else %}
        <div style="opacity:.7;">
          {{ _("–ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä –µ—â—ë –Ω–µ –≤—ã–±—Ä–∞–ª –¥–∞—Ç—ã") }}
        </div>
      {% endif %}
    </div>

    <!-- STATUS MANAGEMENT -->
    <div class="deal-block">
      <h3 style="margin:0 0 12px;">{{ _("–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–º") }}</h3>

      <form method="POST"
            action="/admin/deal/{{ deal.id }}/status"
            class="admin-status-form">

        <div class="input-row">
          <div class="input-group">
            <label>{{ _("–°—Ç–∞—Ç—É—Å —Å–¥–µ–ª–∫–∏") }}</label>
            <select name="status">
              {% for s, label in statuses %}
                <option value="{{ s }}"
                        {% if deal.status == s %}selected{% endif %}>
                  {{ _(label) }}
                </option>
              {% endfor %}
            </select>
          </div>

          <div class="input-group" style="align-self:flex-end;">
            <button class="primary-btn" type="submit">
              {{ _("–°–æ—Ö—Ä–∞–Ω–∏—Ç—å") }}
            </button>
          </div>
        </div>
      </form>

      <form method="POST"
            action="/admin/deal/{{ deal.id }}/cancel"
            class="admin-cancel-form">

        <div class="input-row">
          <div class="input-group">
            <label>{{ _("–û—Ç–º–µ–Ω–∞ —Å–¥–µ–ª–∫–∏ (–ø—Ä–∏—á–∏–Ω–∞)") }}</label>
            <input name="reason"
                   placeholder="{{ _('–ù–∞–ø—Ä.: –¥–æ–∫—É–º–µ–Ω—Ç –Ω–µ –ø—Ä–æ—à—ë–ª –ø—Ä–æ–≤–µ—Ä–∫—É') }}">
          </div>

          <div class="input-group" style="align-self:flex-end;">
            <button class="primary-btn"
                    type="submit"
                    style="background:#e83535;">
              {{ _("–û—Ç–º–µ–Ω–∏—Ç—å") }}
            </button>
          </div>
        </div>
      </form>
    </div>

    <!-- CONTRACT -->
    <div class="deal-block">
      <h3 style="margin:0 0 12px;">{{ _("–î–æ–≥–æ–≤–æ—Ä") }}</h3>

      {% if contract %}
        <div style="margin-bottom:10px;">
          üìÑ <b>{{ _("–î–æ–≥–æ–≤–æ—Ä (PDF, –±–µ–∑ –ø–æ–¥–ø–∏—Å–∏)") }}</b>
          ‚Äî <a href="/static/{{ contract.unsigned_filename }}" target="_blank">{{ _("–û—Ç–∫—Ä—ã—Ç—å") }}</a>
        </div>

        {% set tenant_signed = signed_map.get("tenant") %}
        {% set landlord_signed = signed_map.get("landlord") %}

        <div style="margin-top:12px;">
          <b>{{ _("–ü–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–µ –≤–µ—Ä—Å–∏–∏") }}</b>
        </div>

        <div class="docs-list" style="margin-top:10px;">
          <div class="doc-item">
            <div class="doc-main">
              <div class="doc-title">
                tenant
                {% if tenant_signed %}
                  <span class="doc-status status-approved">{{ _("–ó–∞–≥—Ä—É–∂–µ–Ω–æ") }}</span>
                {% else %}
                  <span class="doc-status status-pending">{{ _("–ï—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ") }}</span>
                {% endif %}
              </div>

              {% if tenant_signed %}
                <a class="doc-link" href="/static/{{ tenant_signed.filename }}" target="_blank">
                  {{ _("–û—Ç–∫—Ä—ã—Ç—å") }}
                </a>
              {% else %}
                <span style="opacity:.7;">‚Äî</span>
              {% endif %}
            </div>
          </div>

          <div class="doc-item">
            <div class="doc-main">
              <div class="doc-title">
                landlord
                {% if landlord_signed %}
                  <span class="doc-status status-approved">{{ _("–ó–∞–≥—Ä—É–∂–µ–Ω–æ") }}</span>
                {% else %}
                  <span class="doc-status status-pending">{{ _("–ï—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ") }}</span>
                {% endif %}
              </div>

              {% if landlord_signed %}
                <a class="doc-link" href="/static/{{ landlord_signed.filename }}" target="_blank">
                  {{ _("–û—Ç–∫—Ä—ã—Ç—å") }}
                </a>
              {% else %}
                <span style="opacity:.7;">‚Äî</span>
              {% endif %}
            </div>
          </div>
        </div>

      {% else %}
        <p style="opacity:.7; margin:0;">
          {{ _("–î–æ–≥–æ–≤–æ—Ä –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º") }}
        </p>
      {% endif %}
    </div>

    <!-- DOCUMENTS -->
    <div class="deal-block">
      <h3 style="margin:0 0 12px;">{{ _("–î–æ–∫—É–º–µ–Ω—Ç—ã") }}</h3>

      <div class="docs-list">
        {% for doc in docs %}
          <div class="doc-item">

            <div class="doc-main">
              <div class="doc-title">
                {{ doc.party }} ‚Ä¢ {{ _(doc.doc_type) }}
                <span class="doc-status status-{{ doc.status }}">
                  {{ _(doc.status) }}
                </span>
              </div>

              <a class="doc-link"
                 href="/static/{{ doc.filename }}"
                 target="_blank">
                {{ _("–û—Ç–∫—Ä—ã—Ç—å") }}
              </a>
            </div>

            <div class="doc-time">
              {{ _("–ó–∞–≥—Ä—É–∂–µ–Ω") }}:
              {{ doc.created_at.strftime("%d.%m.%Y %H:%M") }}

              {% if doc.reviewed_at %}
                ‚Ä¢ {{ _("–ü—Ä–æ–≤–µ—Ä–µ–Ω") }}:
                {{ doc.reviewed_at.strftime("%d.%m.%Y %H:%M") }}
              {% endif %}
            </div>

            {% if doc.note %}
              <div class="doc-note">
                {{ _("–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π") }}: {{ doc.note }}
              </div>
            {% endif %}

            <div class="admin-doc-actions">
              <form method="POST"
                    action="/admin/document/{{ doc.id }}/review">
                <input type="hidden" name="decision" value="approved">
                <button class="primary-btn" type="submit">
                  {{ _("–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å") }}
                </button>
              </form>

              <form method="POST"
                    action="/admin/document/{{ doc.id }}/review">
                <input type="hidden" name="decision" value="rejected">
                <input name="note"
                       placeholder="{{ _('–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞ / —á—Ç–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å') }}">
                <button class="primary-btn"
                        type="submit"
                        style="background:#e83535;">
                  {{ _("–û—Ç–∫–ª–æ–Ω–∏—Ç—å") }}
                </button>
              </form>
            </div>

          </div>
        {% endfor %}

        {% if not docs %}
          <p style="opacity:.7;">
            {{ _("–î–æ–∫—É–º–µ–Ω—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.") }}
          </p>
        {% endif %}
      </div>
    </div>

    <!-- AUDIT -->
    <div class="deal-block">
      <h3 style="margin:0 0 12px;">Audit trail</h3>

      <div class="audit-list">
        {% for a in audit_log %}
          <div class="audit-item">
            <div class="audit-line">
              <b>{{ a.action }}</b>
              <span style="opacity:.65;">
                ‚Äî {{ a.actor.email }}
              </span>
            </div>

            {% if a.meta %}
              <div class="audit-meta">{{ a.meta }}</div>
            {% endif %}

            <div class="audit-time">
              {{ a.created_at.strftime("%d.%m.%Y %H:%M") }}
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

  </div>
</section>

{% endblock %}
